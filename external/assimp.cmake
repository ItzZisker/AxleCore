# Depends on cmake/modules/**

# Automatically downloads and builds Assimp
# Works on Windows, Linux, macOS, Android, WebAssembly (Emscripten)

list(APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/cmake/Modules")

include(ExternalProject)

set(ASSIMP_PREFIX ${CMAKE_SOURCE_DIR}/external/assimp)
set(ASSIMP_SRC_DIR ${ASSIMP_PREFIX}/src)
set(ASSIMP_BUILD_DIR ${ASSIMP_PREFIX}/${AX_PLATFORM_UNIFIED_NAME}/build)
set(ASSIMP_INSTALL_DIR ${ASSIMP_PREFIX}/${AX_PLATFORM_UNIFIED_NAME}/install)
set(ASSIMP_EXTRA_ARGS "")

# ExternalProject Add
ExternalProject_Add(
    assimp
    PREFIX ${ASSIMP_PREFIX}
    STAMP_DIR ${ASSIMP_PREFIX}/assimp-stamp
    GIT_REPOSITORY https://github.com/assimp/assimp.git
    GIT_TAG v6.0.2
    SOURCE_DIR ${ASSIMP_SRC_DIR}
    BINARY_DIR ${ASSIMP_BUILD_DIR}
    INSTALL_DIR ${ASSIMP_INSTALL_DIR}
    CMAKE_ARGS
        -DCMAKE_INSTALL_PREFIX=${ASSIMP_INSTALL_DIR}
        -DASSIMP_BUILD_ALL_EXPORTERS_BY_DEFAULT=ON
        -DASSIMP_BUILD_ALL_IMPORTERS_BY_DEFAULT=ON
        -DASSIMP_BUILD_ASSIMP_TOOLS=ON
        -DASSIMP_BUILD_DOCS=OFF
        -DASSIMP_BUILD_DRACO=OFF
        -DASSIMP_BUILD_FRAMEWORK=OFF
        -DASSIMP_BUILD_M3D_EXPORTER=ON
        -DASSIMP_BUILD_M3D_IMPORTER=ON
        -DASSIMP_BUILD_NONFREE_C4D_IMPORTER=OFF
        -DASSIMP_BUILD_SAMPLES=OFF
        -DASSIMP_BUILD_TESTS=OFF
        -DASSIMP_BUILD_USD_IMPORTER=OFF
        -DASSIMP_BUILD_USD_VERBOSE_LOGS=OFF
        -DASSIMP_BUILD_USE_CCACHE=OFF
        -DASSIMP_BUILD_VRML_IMPORTER=OFF
        -DASSIMP_BUILD_ZLIB=ON
        -DASSIMP_COVERALLS=OFF
        -DASSIMP_DOUBLE_PRECISION=OFF
        -DASSIMP_HUNTER_ENABLED=OFF
        -DASSIMP_IGNORE_GIT_HASH=OFF
        -DASSIMP_INCLUDE_INSTALL_DIR=include
        -DASSIMP_INJECT_DEBUG_POSTFIX=ON
        -DASSIMP_RAPIDJSON_NO_MEMBER_ITERATOR=ON
        -DASSIMP_UBSAN=OFF
        -DASSIMP_WARNINGS_AS_ERRORS=OFF
        -DASSIMP_INSTALL=ON
        -DBUILD_SHARED_LIBS=OFF
    UPDATE_DISCONNECTED 1
    BUILD_ALWAYS 1
    BUILD_IN_SOURCE 0
)

# Create imported target for linking
add_library(Assimp STATIC IMPORTED GLOBAL)
set_target_properties(Assimp PROPERTIES
    IMPORTED_LOCATION ${ASSIMP_INSTALL_DIR}/lib/libassimp.a
)
